(window.webpackJsonp=window.webpackJsonp||[]).push([[579],{957:function(e,t,i){"use strict";i.r(t);var _=i(26),v=Object(_.a)({},(function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[i("h1",{attrs:{id:"消息中心各场景消息发送逻辑"}},[i("a",{staticClass:"header-anchor",attrs:{href:"#消息中心各场景消息发送逻辑"}},[e._v("#")]),e._v(" 消息中心各场景消息发送逻辑")]),e._v(" "),i("h2",{attrs:{id:"_1-简介"}},[i("a",{staticClass:"header-anchor",attrs:{href:"#_1-简介"}},[e._v("#")]),e._v(" 1. 简介")]),e._v(" "),i("p",[e._v("消息中心在各场景下的发送逻辑是不一致的，例如")]),e._v(" "),i("ul",[i("li",[e._v("发送给单人的业务消息。我们希望发送完消息后，用户立即收到消息")]),e._v(" "),i("li",[e._v("而像类似通知公告这类消息，面向的是所有用户，那么我们不可能一次性发给所有用户。所以我们采用登录或进入首页后，重新拉取新消息的模式")])]),e._v(" "),i("h2",{attrs:{id:"_2-接口设计"}},[i("a",{staticClass:"header-anchor",attrs:{href:"#_2-接口设计"}},[e._v("#")]),e._v(" 2. 接口设计")]),e._v(" "),i("p",[e._v("NotifyService拥有以下方法:")]),e._v(" "),i("ul",[i("li",[e._v("createAnnounce(content, sender)\n"),i("ol",[i("li",[e._v("往Notify表中插入一条公告记录")])])]),e._v(" "),i("li",[e._v("createRemind(target, targetType, action, sender, content)\n"),i("ol",[i("li",[e._v("往Notify表中插入一条提醒记录")])])]),e._v(" "),i("li",[e._v("createMessage(content, sender, receiver)\n"),i("ol",[i("li",[e._v("往Notify表中插入一条信息记录")]),e._v(" "),i("li",[e._v("往UserNotify表中插入一条记录，并关联新建的Notify")])])]),e._v(" "),i("li",[e._v("pullAnnounce(user)\n"),i("ol",[i("li",[e._v("从UserNotify中获取最近的一条公告信息的创建时间: "),i("code",[e._v("lastTime")])]),e._v(" "),i("li",[e._v("用"),i("code",[e._v("lastTime")]),e._v("作为过滤条件，查询Notify的公告信息")]),e._v(" "),i("li",[e._v("新建UserNotify并关联查询出来的公告信息")])])]),e._v(" "),i("li",[e._v("pullRemind(user)\n"),i("ol",[i("li",[e._v("查询用户的订阅表，得到用户的一系列订阅记录")]),e._v(" "),i("li",[e._v("通过每一条的订阅记录的"),i("code",[e._v("target")]),e._v("、"),i("code",[e._v("targetType")]),e._v("、"),i("code",[e._v("action")]),e._v("、"),i("code",[e._v("createdAt")]),e._v("去查询Notify表，获取订阅的Notify记录。（注意订阅时间必须早于提醒创建时间）")]),e._v(" "),i("li",[e._v("查询用户的配置文件SubscriptionConfig，如果没有则使用默认的配置DefaultSubscriptionConfig")]),e._v(" "),i("li",[e._v("使用订阅配置，过滤查询出来的Notify")]),e._v(" "),i("li",[e._v("使用过滤好的Notify作为关联新建UserNotify")])])]),e._v(" "),i("li",[e._v("subscribe(user, target, targetType, reason)\n"),i("ol",[i("li",[e._v("通过reason，查询NotifyConfig，获取对应的动作组:"),i("code",[e._v("actions")])]),e._v(" "),i("li",[e._v("遍历动作组，每一个动作新建一则Subscription记录")])])]),e._v(" "),i("li",[e._v("cancelSubscription(user, target ,targetType)\n"),i("ol",[i("li",[e._v("删除"),i("code",[e._v("user")]),e._v("、"),i("code",[e._v("target")]),e._v("、"),i("code",[e._v("targetType")]),e._v("对应的一则或多则记录")])])]),e._v(" "),i("li",[e._v("getSubscriptionConfig(userID)\n"),i("ol",[i("li",[e._v("查询SubscriptionConfig表，获取用户的订阅配置")])])]),e._v(" "),i("li",[e._v("updateSubscriptionConfig(userID)\n"),i("ol",[i("li",[e._v("更新用户的SubscriptionConfig记录")])])]),e._v(" "),i("li",[e._v("getUserNotify(userID)\n"),i("ol",[i("li",[e._v("获取用户的消息列表")])])]),e._v(" "),i("li",[e._v("read(user, notifyIDs)\n"),i("ol",[i("li",[e._v("更新指定的notify，把isRead属性设置为true")])])])]),e._v(" "),i("h2",{attrs:{id:"_3-各场景发送逻辑"}},[i("a",{staticClass:"header-anchor",attrs:{href:"#_3-各场景发送逻辑"}},[e._v("#")]),e._v(" 3. 各场景发送逻辑")]),e._v(" "),i("h3",{attrs:{id:"_3-1-提醒的订阅、创建、拉取"}},[i("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-提醒的订阅、创建、拉取"}},[e._v("#")]),e._v(" 3.1 提醒的订阅、创建、拉取")]),e._v(" "),i("p",[i("img",{attrs:{src:"https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/blogimage-master/image-20211103151303897.png",alt:"image-20211103151303897"}})]),e._v(" "),i("ol",[i("li",[e._v("我们可以在产品创建之后，调用"),i("code",[e._v("NotifyService.subscribe")]),e._v("方法，")]),e._v(" "),i("li",[e._v("然后在产品被评论之后调用"),i("code",[e._v("NotifyService.createRemind")]),e._v("方法，")]),e._v(" "),i("li",[e._v("再就是用户登录系统或者其他的某一个时刻调")]),e._v(" "),i("li",[e._v("用"),i("code",[e._v("NotifyService.pullRemind")]),e._v("方法，\n最后在用户查询消息队列的时候调用"),i("code",[e._v("NotifyService.getUserNotify")]),e._v("方法。")])]),e._v(" "),i("h3",{attrs:{id:"_3-2-公告的创建、拉取"}},[i("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-公告的创建、拉取"}},[e._v("#")]),e._v(" 3.2 公告的创建、拉取")]),e._v(" "),i("p",[i("img",{attrs:{src:"https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/blogimage-master/image-20211103151351090.png",alt:"image-20211103151351090"}})]),e._v(" "),i("ol",[i("li",[e._v("在管理员发送了一则公告的时候，调用"),i("code",[e._v("NotifyService.createAnnounce")]),e._v("方法，")]),e._v(" "),i("li",[e._v("然后在用户登录系统或者其他的某一个时刻调用"),i("code",[e._v("NotifyService.pullAnnounce")]),e._v("方法，")]),e._v(" "),i("li",[e._v("最后在用户查询消息队列的时候调用"),i("code",[e._v("NotifyService.getUserNotify")]),e._v("方法。")])]),e._v(" "),i("h3",{attrs:{id:"_3-3-信息的创建"}},[i("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-信息的创建"}},[e._v("#")]),e._v(" 3.3 信息的创建")]),e._v(" "),i("p",[i("img",{attrs:{src:"https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/blogimage-master/image-20211103151524274.png",alt:"image-20211103151524274"}})]),e._v(" "),i("p",[e._v("信息的创建，只需要直接调用"),i("code",[e._v("NotifyService.createMessage")]),e._v("方法就可以了，\n在下一次用户查询消息队列的时候，就会查询这条信息。")]),e._v(" "),i("h2",{attrs:{id:"参考文章"}},[i("a",{staticClass:"header-anchor",attrs:{href:"#参考文章"}},[e._v("#")]),e._v(" 参考文章")]),e._v(" "),i("p",[i("a",{attrs:{href:"https://www.jianshu.com/p/6bf8166b291c",target:"_blank",rel:"noopener noreferrer"}},[e._v("消息系统设计与实现「下篇」"),i("OutboundLink")],1)])])}),[],!1,null,null,null);t.default=v.exports}}]);