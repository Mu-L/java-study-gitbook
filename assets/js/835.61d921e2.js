(window.webpackJsonp=window.webpackJsonp||[]).push([[835],{1212:function(a,s,t){"use strict";t.r(s);var _=t(26),e=Object(_.a)({},(function(){var a=this,s=a.$createElement,t=a._self._c||s;return t("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[t("h1",{attrs:{id:"redis持久化"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#redis持久化"}},[a._v("#")]),a._v(" Redis持久化")]),a._v(" "),t("h2",{attrs:{id:"_1-简介"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-简介"}},[a._v("#")]),a._v(" 1. 简介")]),a._v(" "),t("p",[a._v("redis将数据存在内存中，我们要怎么保证redis挂掉之后再重启数据可以进行恢复呢？")]),a._v(" "),t("p",[a._v("这时候就需要数据持久化。redis支持以下两种持久化")]),a._v(" "),t("ul",[t("li",[a._v("RDB(快照)持久化：保存某个时间点的全量数据快照")]),a._v(" "),t("li",[a._v("AOF(Append-Only-File)持久化：保存写状态")])]),a._v(" "),t("h2",{attrs:{id:"_2-rdb-快照-持久化"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-rdb-快照-持久化"}},[a._v("#")]),a._v(" 2. RDB(快照)持久化")]),a._v(" "),t("p",[a._v("保存某个时间点的全量数据快照")]),a._v(" "),t("ul",[t("li",[a._v("优点：\n"),t("ul",[t("li",[a._v("全量数据快照，文件小，恢复快")])])]),a._v(" "),t("li",[a._v("缺点\n"),t("ul",[t("li",[a._v("内存数据的全量同步，数据量大会由于I/O 而严重影响性能")]),a._v(" "),t("li",[a._v("可能会因为Redis挂掉而丢失从当前至最近一次快照期间的数据")])])])]),a._v(" "),t("h3",{attrs:{id:"_2-1-rdb配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-rdb配置"}},[a._v("#")]),a._v(" 2.1 RDB配置")]),a._v(" "),t("h4",{attrs:{id:"_2-1-1-save配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-1-save配置"}},[a._v("#")]),a._v(" 2.1.1 save配置")]),a._v(" "),t("p",[t("img",{attrs:{src:"https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/blogimage-master/image-20210411114052591.png",alt:"image-20210411114052591"}})]),a._v(" "),t("ul",[t("li",[t("p",[a._v("save 900 1")]),a._v(" "),t("p",[a._v("#在900秒(15分钟)之后，如果至少有1个key发生变化，Redis就会自动触发BGSAVE命令创建快照。")])]),a._v(" "),t("li",[t("p",[a._v("save 300 10")]),a._v(" "),t("p",[a._v("#在300秒(5分钟)之后，如果至少有10个key发生变化，Redis就会自动触发BGSAVE命令创建快照。")])]),a._v(" "),t("li",[t("p",[a._v("save 60 10000")]),a._v(" "),t("p",[a._v("#在60秒(1分钟)之后，如果至少有10000个key发生变化，Redis就会自动触发BGSAVE命令创建快照。")])])]),a._v(" "),t("h4",{attrs:{id:"_2-1-2-stop-writes-ob-bgsave-error-配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-2-stop-writes-ob-bgsave-error-配置"}},[a._v("#")]),a._v(" 2.1.2 stop-writes-ob-bgsave-error 配置")]),a._v(" "),t("p",[t("img",{attrs:{src:"https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/blogimage-master/image-20210411114416349.png",alt:"image-20210411114416349"}})]),a._v(" "),t("p",[a._v("设置为yes：当备份进程出错的时候，就不新写入数据了")]),a._v(" "),t("h4",{attrs:{id:"_2-1-3-rbd压缩配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-3-rbd压缩配置"}},[a._v("#")]),a._v(" 2.1.3 rbd压缩配置")]),a._v(" "),t("p",[t("img",{attrs:{src:"https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/blogimage-master/image-20210411114539673.png",alt:"image-20210411114539673"}})]),a._v(" "),t("p",[a._v("设置成yes：压缩")]),a._v(" "),t("p",[a._v("建议设置成no。redis本来就属于cpu密集操作，压缩会带来更大的cpu消耗，相比硬盘成本cpu更值钱")]),a._v(" "),t("h4",{attrs:{id:"_2-1-4-如何禁用rdb配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-4-如何禁用rdb配置"}},[a._v("#")]),a._v(" 2.1.4 如何禁用rdb配置")]),a._v(" "),t("p",[t("img",{attrs:{src:"https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/blogimage-master/image-20210411114757555.png",alt:"image-20210411114757555"}})]),a._v(" "),t("p",[a._v("给save设置空值")]),a._v(" "),t("h3",{attrs:{id:"_2-2-rdb文件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-rdb文件"}},[a._v("#")]),a._v(" 2.2 RDB文件")]),a._v(" "),t("p",[a._v("redis 会定期生成dump.rdb文件")]),a._v(" "),t("p",[t("img",{attrs:{src:"https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/blogimage-master/image-20210411115003197.png",alt:"image-20210411115003197"}})]),a._v(" "),t("p",[a._v("我们打开可以发现是一堆看不懂的乱码")]),a._v(" "),t("p",[t("img",{attrs:{src:"https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/blogimage-master/image-20210411115123958.png",alt:"image-20210411115123958"}})]),a._v(" "),t("p",[a._v("也就表明dump.rdb 是二进制文件")]),a._v(" "),t("h3",{attrs:{id:"_2-3-rdb-持久化方式"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-rdb-持久化方式"}},[a._v("#")]),a._v(" 2.3 RDB 持久化方式")]),a._v(" "),t("ul",[t("li",[a._v("SAVE: 阻塞Redis的服务进程，知道RDB文件被创建完成")]),a._v(" "),t("li",[t("strong",[a._v("BGSAVE: Fork 出一个子进程来创建RDB文件，不阻塞服务器进程")])])]),a._v(" "),t("h4",{attrs:{id:"_2-3-1-save-很少用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-1-save-很少用"}},[a._v("#")]),a._v(" 2.3.1 SAVE(很少用)")]),a._v(" "),t("p",[a._v("SAVE 因为会阻塞主线程，很少被操作，")]),a._v(" "),t("h5",{attrs:{id:"_2-3-1-1-示例"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-1-1-示例"}},[a._v("#")]),a._v(" 2.3.1.1 示例")]),a._v(" "),t("ul",[t("li",[t("p",[a._v("备份")]),a._v(" "),t("p",[t("img",{attrs:{src:"https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/blogimage-master/image-20210411120115269.png",alt:"image-20210411120115269"}})]),a._v(" "),t("p",[a._v("执行save后会卡着一段时间，直到备份完成")])]),a._v(" "),t("li",[t("p",[a._v("lastsave：查看最后备份时间")])])]),a._v(" "),t("p",[t("img",{attrs:{src:"https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/blogimage-master/image-20210411120242935.png",alt:"image-20210411120242935"}})]),a._v(" "),t("ul",[t("li",[t("p",[a._v("定时备份：")]),a._v(" "),t("p",[a._v("我们可以用java定时器来定时备份，并将dump文件改名")]),a._v(" "),t("p",[t("img",{attrs:{src:"https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/blogimage-master/image-20210411120407537.png",alt:"image-20210411120407537"}})])])]),a._v(" "),t("h4",{attrs:{id:"_2-3-2-bgsave-常用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-2-bgsave-常用"}},[a._v("#")]),a._v(" 2.3.2 BGSAVE(常用)")]),a._v(" "),t("p",[a._v("该方法会fork出子进程，真正的持久化过程是在子进程中执行的，主进程会继续提供服务；")]),a._v(" "),t("h5",{attrs:{id:"_2-3-2-1-原理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-2-1-原理"}},[a._v("#")]),a._v(" 2.3.2.1 原理")]),a._v(" "),t("p",[t("img",{attrs:{src:"https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/blogimage-master/image-20210411121020117.png",alt:"image-20210411121020117"}})]),a._v(" "),t("h3",{attrs:{id:"_2-4-自动触发rdb持久化的方式"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-自动触发rdb持久化的方式"}},[a._v("#")]),a._v(" 2.4 自动触发RDB持久化的方式")]),a._v(" "),t("ul",[t("li",[a._v("根据redis.conf 配置里的SAVE m n 定时触发（用的是BGSAVE）")]),a._v(" "),t("li",[a._v("主从复制时，主节点自动触发")]),a._v(" "),t("li",[a._v("执行Debug Reload")]),a._v(" "),t("li",[a._v("执行Shutdown且没有开启AOF持久化")])]),a._v(" "),t("h2",{attrs:{id:"_3-aof-append-only-file-持久化-保存写状态"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-aof-append-only-file-持久化-保存写状态"}},[a._v("#")]),a._v(" 3.AOF(Append-Only-File)持久化：保存写状态")]),a._v(" "),t("ul",[t("li",[a._v("记录下除了查询以外的所有变更数据状态的指令")]),a._v(" "),t("li",[a._v("以append的形式追加保存到AOF文件中（增量）")])]),a._v(" "),t("p",[a._v("优点：")]),a._v(" "),t("ul",[t("li",[a._v("可读性高，适合保存增量数据，数据不易丢失")])]),a._v(" "),t("p",[a._v("缺点：")]),a._v(" "),t("ul",[t("li",[a._v("文件体积大，恢复时间长")])]),a._v(" "),t("h3",{attrs:{id:"_3-1-aof-配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-aof-配置"}},[a._v("#")]),a._v(" 3.1 AOF 配置")]),a._v(" "),t("h4",{attrs:{id:"_3-1-1-aof-启动状态"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-1-aof-启动状态"}},[a._v("#")]),a._v(" 3.1.1 AOF 启动状态")]),a._v(" "),t("p",[a._v("AOF 默认是关闭的")]),a._v(" "),t("p",[t("img",{attrs:{src:"https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/blogimage-master/image-20210411150040293.png",alt:"image-20210411150040293"}})]),a._v(" "),t("h4",{attrs:{id:"_3-1-2-aof-生成的文件名"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-2-aof-生成的文件名"}},[a._v("#")]),a._v(" 3.1.2 AOF 生成的文件名")]),a._v(" "),t("p",[t("img",{attrs:{src:"https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/blogimage-master/image-20210411150146946.png",alt:"image-20210411150146946"}})]),a._v(" "),t("h4",{attrs:{id:"_3-1-3-aof的写入方式"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-3-aof的写入方式"}},[a._v("#")]),a._v(" 3.1.3 aof的写入方式")]),a._v(" "),t("p",[t("img",{attrs:{src:"https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/blogimage-master/image-20210411150239597.png",alt:"image-20210411150239597"}})]),a._v(" "),t("ul",[t("li",[t("p",[a._v("always：表示缓存区方式变化，总是及时将内容写入aof中")])]),a._v(" "),t("li",[t("p",[a._v("everyses： 每隔一秒去写入")])]),a._v(" "),t("li",[t("p",[a._v("No: 交给操作系统来决定")])])]),a._v(" "),t("h3",{attrs:{id:"_3-2-aof-开启"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-aof-开启"}},[a._v("#")]),a._v(" 3.2 AOF 开启")]),a._v(" "),t("ol",[t("li",[t("p",[a._v("开启")]),a._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("appendonly yes\n")])])])]),a._v(" "),t("li",[t("p",[a._v("开启后需要重新启动redis 服务器")]),a._v(" "),t("p",[a._v("在客户端执行shutdown 的时候，服务端可以看到发送了shutdown指令和发送save指令")]),a._v(" "),t("p",[t("img",{attrs:{src:"https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/blogimage-master/image-20210411152635369.png",alt:"image-20210411152635369"}})])]),a._v(" "),t("li",[t("p",[a._v("配置")]),a._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("config set appendonly yes\n")])])])]),a._v(" "),t("li",[t("p",[a._v("添加测试数据")]),a._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v('set aoftest "hahah"\nexit\n')])])])]),a._v(" "),t("li",[t("p",[a._v("添加后可以看到appendonly.aof文件")]),a._v(" "),t("p",[t("img",{attrs:{src:"https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/blogimage-master/image-20210411153459664.png",alt:"image-20210411153459664"}})])])]),a._v(" "),t("h3",{attrs:{id:"_3-3-日志重写-解决aof-文件大小不断增大问题"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-日志重写-解决aof-文件大小不断增大问题"}},[a._v("#")]),a._v(" 3.3 日志重写：解决AOF 文件大小不断增大问题")]),a._v(" "),t("ul",[t("li",[a._v("调用fork（），创建一个子进程")]),a._v(" "),t("li",[a._v("子进程把新的AOF写到一个临时文件里，不依赖原来的AOF文件")]),a._v(" "),t("li",[a._v("主进程持续将新的变动同时写到内存和原来的AOF里")]),a._v(" "),t("li",[a._v("主进程获取子进程重写AOF的完成信号，往新AOF同步增量变动")]),a._v(" "),t("li",[a._v("使用新的AOF文件替换掉旧的AOF文件")])]),a._v(" "),t("h2",{attrs:{id:"_4-rdb和aof文件共存的情况下回复流程"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-rdb和aof文件共存的情况下回复流程"}},[a._v("#")]),a._v(" 4. RDB和AOF文件共存的情况下回复流程")]),a._v(" "),t("p",[t("img",{attrs:{src:"https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/blogimage-master/image-20210411154143065.png",alt:"image-20210411154143065"}})]),a._v(" "),t("ul",[t("li",[a._v("存在AOF 文件，则执行AOF")]),a._v(" "),t("li",[a._v("不存在AOF则恢复RDB")])]),a._v(" "),t("h2",{attrs:{id:"_5-rdb对比"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-rdb对比"}},[a._v("#")]),a._v(" 5. RDB对比")]),a._v(" "),t("table",[t("thead",[t("tr",[t("th",[a._v("方式")]),a._v(" "),t("th",[a._v("优点")]),a._v(" "),t("th",[a._v("缺点")])])]),a._v(" "),t("tbody",[t("tr",[t("td",[a._v("RDB")]),a._v(" "),t("td",[a._v("全量数据快照，文件小，恢复快")]),a._v(" "),t("td",[a._v("无法保存最近一次快照之后的数据")])]),a._v(" "),t("tr",[t("td",[a._v("AOF")]),a._v(" "),t("td",[a._v("可读性高，适合保存增量数据，数据不易丢失")]),a._v(" "),t("td",[a._v("文件体积大，恢复时间长")])])])]),a._v(" "),t("p",[a._v("有没有一种结合两种优点的模式呢？既使用rdb全量备份，aof来增量备份。这就是混合模式，现在已经作为redis 的默认配置")]),a._v(" "),t("h2",{attrs:{id:"_6-rdb-aof混合持久化方式"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-rdb-aof混合持久化方式"}},[a._v("#")]),a._v(" 6. RDB-AOF混合持久化方式")]),a._v(" "),t("p",[t("img",{attrs:{src:"https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/blogimage-master/image-20210411154937324.png",alt:"image-20210411154937324"}})]),a._v(" "),t("ul",[t("li",[a._v("BGSAVE 做镜像全量持久化")]),a._v(" "),t("li",[a._v("AOF 做增量持久化")])])])}),[],!1,null,null,null);s.default=e.exports}}]);