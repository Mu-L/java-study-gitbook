(window.webpackJsonp=window.webpackJsonp||[]).push([[217],{597:function(t,e,a){"use strict";a.r(e);var r=a(26),n=Object(r.a)({},(function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"从sql到mongodb之聚合篇"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#从sql到mongodb之聚合篇"}},[t._v("#")]),t._v(" 从SQL到MongoDB之聚合篇")]),t._v(" "),a("h2",{attrs:{id:"_1-简介"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-简介"}},[t._v("#")]),t._v(" 1. 简介")]),t._v(" "),a("p",[t._v("聚合管道 （ "),a("a",{attrs:{href:"https://docs.mongodb.com/manual/core/aggregation-pipeline/",target:"_blank",rel:"noopener noreferrer"}},[t._v("aggregation pipeline "),a("OutboundLink")],1),t._v("） 让 MongoDB 提供与 SQL 中的许多常见数据聚合操作相对应的，原生的聚合功能。")]),t._v(" "),a("h3",{attrs:{id:"_1-1-术语"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-术语"}},[t._v("#")]),t._v(" 1.1 术语")]),t._v(" "),a("p",[t._v("下表概述了常见的 SQL 聚合术语、函数和概念以及相应的 MongoDB 聚合操作符（ "),a("a",{attrs:{href:"https://docs.mongodb.com/manual/reference/operator/aggregation-pipeline/#aggregation-pipeline-operator-reference",target:"_blank",rel:"noopener noreferrer"}},[t._v("aggregation operators "),a("OutboundLink")],1),t._v("）：")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("SQL 术语、函数和概念")]),t._v(" "),a("th",[t._v("MongoDB 聚合操作符")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("WHERE")]),t._v(" "),a("td",[a("a",{attrs:{href:"https://docs.mongodb.com/manual/reference/operator/aggregation/match/#pipe._S_match",target:"_blank",rel:"noopener noreferrer"}},[t._v("$match"),a("OutboundLink")],1)])]),t._v(" "),a("tr",[a("td",[t._v("GROUP BY")]),t._v(" "),a("td",[a("a",{attrs:{href:"https://docs.mongodb.com/manual/reference/operator/aggregation/group/#pipe._S_group",target:"_blank",rel:"noopener noreferrer"}},[t._v("$group"),a("OutboundLink")],1)])]),t._v(" "),a("tr",[a("td",[t._v("HAVING")]),t._v(" "),a("td",[a("a",{attrs:{href:"https://docs.mongodb.com/manual/reference/operator/aggregation/match/#pipe._S_match",target:"_blank",rel:"noopener noreferrer"}},[t._v("$match"),a("OutboundLink")],1)])]),t._v(" "),a("tr",[a("td",[t._v("SELECT")]),t._v(" "),a("td",[a("a",{attrs:{href:"https://docs.mongodb.com/manual/reference/operator/aggregation/project/#pipe._S_project",target:"_blank",rel:"noopener noreferrer"}},[t._v("$project"),a("OutboundLink")],1)])]),t._v(" "),a("tr",[a("td",[t._v("ORDER BY")]),t._v(" "),a("td",[a("a",{attrs:{href:"https://docs.mongodb.com/manual/reference/operator/aggregation/sort/#pipe._S_sort",target:"_blank",rel:"noopener noreferrer"}},[t._v("$sort"),a("OutboundLink")],1)])]),t._v(" "),a("tr",[a("td",[t._v("LIMIT")]),t._v(" "),a("td",[a("a",{attrs:{href:"https://docs.mongodb.com/manual/reference/operator/aggregation/limit/#pipe._S_limit",target:"_blank",rel:"noopener noreferrer"}},[t._v("$limit"),a("OutboundLink")],1)])]),t._v(" "),a("tr",[a("td",[t._v("SUM()")]),t._v(" "),a("td",[a("a",{attrs:{href:"https://docs.mongodb.com/manual/reference/operator/aggregation/sum/#grp._S_sum",target:"_blank",rel:"noopener noreferrer"}},[t._v("$sum"),a("OutboundLink")],1)])]),t._v(" "),a("tr",[a("td",[t._v("COUNT()")]),t._v(" "),a("td",[a("a",{attrs:{href:"https://docs.mongodb.com/manual/reference/operator/aggregation/sum/#grp._S_sum",target:"_blank",rel:"noopener noreferrer"}},[t._v("$sum "),a("OutboundLink")],1),a("a",{attrs:{href:"https://docs.mongodb.com/manual/reference/operator/aggregation/sortByCount/#pipe._S_sortByCount",target:"_blank",rel:"noopener noreferrer"}},[t._v("$sortByCount"),a("OutboundLink")],1)])]),t._v(" "),a("tr",[a("td",[t._v("join")]),t._v(" "),a("td",[a("a",{attrs:{href:"https://docs.mongodb.com/manual/reference/operator/aggregation/lookup/#pipe._S_lookup",target:"_blank",rel:"noopener noreferrer"}},[t._v("$lookup"),a("OutboundLink")],1)])]),t._v(" "),a("tr",[a("td",[t._v("SELECT INTO NEW_TABLE")]),t._v(" "),a("td",[a("a",{attrs:{href:"https://docs.mongodb.com/manual/reference/operator/aggregation/out/#pipe._S_out",target:"_blank",rel:"noopener noreferrer"}},[t._v("$out"),a("OutboundLink")],1)])]),t._v(" "),a("tr",[a("td",[t._v("MERGE INTO TABLE")]),t._v(" "),a("td",[a("a",{attrs:{href:"https://docs.mongodb.com/manual/reference/operator/aggregation/merge/#pipe._S_merge",target:"_blank",rel:"noopener noreferrer"}},[t._v("$merge "),a("OutboundLink")],1),t._v("MongoDB 4.2 可用")])])])]),t._v(" "),a("p",[t._v("有关所有聚合管道和表达式操作符的列表，请参见： "),a("a",{attrs:{href:"https://docs.mongodb.com/manual/meta/aggregation-quick-reference/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Aggregation Pipeline Quick Reference "),a("OutboundLink")],1),t._v("。")]),t._v(" "),a("h2",{attrs:{id:"_2-语法示例"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-语法示例"}},[t._v("#")]),t._v(" 2. 语法示例")]),t._v(" "),a("p",[t._v("下面提供了 SQL 聚合语句和相应的 MongoDB 语句，表中的例子假定以下条件：")]),t._v(" "),a("ul",[a("li",[t._v("SQL 示例假定有两个表："),a("code",[t._v("orders")]),t._v(" 和 "),a("code",[t._v("order_lineitem")]),t._v("，然后通过 "),a("code",[t._v("order_lineitem.order_id")]),t._v(" 和 "),a("code",[t._v("orders.id")]),t._v(" 进行 "),a("code",[t._v("join")]),t._v(" 操作。")]),t._v(" "),a("li",[t._v("MongoDB 示例假设其中一个集合（collection） "),a("code",[t._v("orders")]),t._v(" 包含以下原型的文档（documents）：")])]),t._v(" "),a("div",{staticClass:"language-json extra-class"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  cust_id"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"abc123"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  ord_date"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" ISODate("),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2012-11-02T17:04:11.102Z"')]),t._v(")"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  status"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" 'A'"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  price"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("50")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  items"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" sku"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"xxx"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" qty"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("25")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" price"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n           "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" sku"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"yyy"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" qty"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("25")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" price"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h3",{attrs:{id:"_2-1-count-vs-count"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-count-vs-count"}},[t._v("#")]),t._v(" 2.1 COUNT vs count")]),t._v(" "),a("p",[t._v("计算所有 "),a("code",[t._v("orders")]),t._v(" 记录数量：")]),t._v(" "),a("ul",[a("li",[t._v("SQL 示例")])]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("SELECT COUNT(*) AS count\nFROM orders\n")])])]),a("ul",[a("li",[t._v("MongoDB 示例")])]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("db.orders.aggregate( [\n   {\n     $group: {\n        _id: null,\n        count: { $sum: 1 }\n     }\n   }\n] )\n")])])]),a("h3",{attrs:{id:"_2-2-sum-vs-sum"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-sum-vs-sum"}},[t._v("#")]),t._v(" 2.2 SUM vs "),a("code",[t._v("$sum")])]),t._v(" "),a("p",[t._v("计算 "),a("code",[t._v("orders")]),t._v(" 中 "),a("code",[t._v("price")]),t._v(" 的总和：")]),t._v(" "),a("ul",[a("li",[t._v("SQL 示例")])]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("SELECT SUM(price) AS total\nFROM orders\n")])])]),a("ul",[a("li",[t._v("MongoDB 示例")])]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('db.orders.aggregate( [\n   {\n     $group: {\n        _id: null,\n        total: { $sum: "$price" }\n     }\n   }\n] )\n')])])]),a("h3",{attrs:{id:"_2-3-group-by-vs-group"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-group-by-vs-group"}},[t._v("#")]),t._v(" 2.3 GROUP BY vs "),a("code",[t._v("$group")])]),t._v(" "),a("p",[t._v("对于每一个独特的 "),a("code",[t._v("cust_id")]),t._v("，计算 "),a("code",[t._v("price")]),t._v(" 字段总和：")]),t._v(" "),a("ul",[a("li",[t._v("SQL 示例")])]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("SELECT cust_id,\n       SUM(price) AS total\nFROM orders\nGROUP BY cust_id\n")])])]),a("ul",[a("li",[t._v("MongoDB 示例")])]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('db.orders.aggregate( [\n   {\n     $group: {\n        _id: "$cust_id",\n        total: { $sum: "$price" }\n     }\n   }\n] )\n')])])]),a("h3",{attrs:{id:"_2-4-order-by-vs-sort"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-order-by-vs-sort"}},[t._v("#")]),t._v(" 2.4 ORDER BY vs "),a("code",[t._v("$sort")])]),t._v(" "),a("p",[t._v("对于每一个独特的 "),a("code",[t._v("cust_id")]),t._v("，计算 "),a("code",[t._v("price")]),t._v(" 字段总和，且结果按总和排序：")]),t._v(" "),a("ul",[a("li",[t._v("SQL 示例")])]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("SELECT cust_id,\n       SUM(price) AS total\nFROM orders\nGROUP BY cust_id\nORDER BY total\n")])])]),a("ul",[a("li",[t._v("MongoDB 示例")])]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('db.orders.aggregate( [\n   {\n     $group: {\n        _id: "$cust_id",\n        total: { $sum: "$price" }\n     }\n   },\n   { $sort: { total: 1 } }\n] )\n')])])]),a("h3",{attrs:{id:"_2-5-group-by-multi"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-5-group-by-multi"}},[t._v("#")]),t._v(" 2.5 GROUP BY Multi")]),t._v(" "),a("p",[t._v("对于每一个独特的 "),a("code",[t._v("cust_id")]),t._v("，按照 "),a("code",[t._v("ord_date")]),t._v(" 进行分组，且不包含日期的时间部分，计算 "),a("code",[t._v("price")]),t._v(" 字段总和。")]),t._v(" "),a("ul",[a("li",[t._v("SQL 示例")])]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("SELECT cust_id,\n       ord_date,\n       SUM(price) AS total\nFROM orders\nGROUP BY cust_id,\n         ord_date\n")])])]),a("ul",[a("li",[t._v("MongoDB 示例")])]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('db.orders.aggregate( [\n   {\n     $group: {\n        _id: {\n           cust_id: "$cust_id",\n           ord_date: { $dateToString: {\n              format: "%Y-%m-%d",\n              date: "$ord_date"\n           }}\n        },\n        total: { $sum: "$price" }\n     }\n   }\n] )\n')])])]),a("h3",{attrs:{id:"_2-6-having-vs-match"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-6-having-vs-match"}},[t._v("#")]),t._v(" 2.6 HAVING vs "),a("code",[t._v("$match")])]),t._v(" "),a("p",[t._v("对于 "),a("code",[t._v("cust_id")]),t._v(" 如果有多个记录，就返回 "),a("code",[t._v("cust_id")]),t._v(" 以及相应的记录数量：")]),t._v(" "),a("ul",[a("li",[t._v("SQL 示例")])]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("SELECT cust_id,\n       count(*)\nFROM orders\nGROUP BY cust_id\nHAVING count(*) > 1\n")])])]),a("ul",[a("li",[t._v("MongoDB 示例")])]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('db.orders.aggregate( [\n   {\n     $group: {\n        _id: "$cust_id",\n        count: { $sum: 1 }\n     }\n   },\n   { $match: { count: { $gt: 1 } } }\n] )\n')])])]),a("h3",{attrs:{id:"_2-7-where-vs-match"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-7-where-vs-match"}},[t._v("#")]),t._v(" 2.7 WHERE vs "),a("code",[t._v("$match")])]),t._v(" "),a("p",[t._v("对于每一个独特的 "),a("code",[t._v("cust_id")]),t._v("，且 "),a("code",[t._v("status = ‘A’")]),t._v("，计算 "),a("code",[t._v("price")]),t._v(" 字段总和，只有在总和大于 250 的情况下，才可以返回。")]),t._v(" "),a("ul",[a("li",[t._v("SQL 示例")])]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("SELECT cust_id,\n       SUM(price) as total\nFROM orders\nWHERE status = 'A'\nGROUP BY cust_id\nHAVING total > 250\n")])])]),a("ul",[a("li",[t._v("MongoDB 示例")])]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('db.orders.aggregate( [\n   { $match: { status: \'A\' } },\n   {\n     $group: {\n        _id: "$cust_id",\n        total: { $sum: "$price" }\n     }\n   },\n   { $match: { total: { $gt: 250 } } }\n] )\n')])])]),a("h3",{attrs:{id:"_2-8-unwind"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-8-unwind"}},[t._v("#")]),t._v(" 2.8 "),a("code",[t._v("$unwind")])]),t._v(" "),a("p",[t._v("对于每一个独特的 "),a("code",[t._v("cust_id")]),t._v("，对相应的行的 item 项求和得到 "),a("code",[t._v("qty")]),t._v("：")]),t._v(" "),a("ul",[a("li",[t._v("SQL 示例")])]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("SELECT cust_id,\n       SUM(li.qty) as qty\nFROM orders o,\n     order_lineitem li\nWHERE li.order_id = o.id\nGROUP BY cust_id\n")])])]),a("ul",[a("li",[t._v("MongoDB 示例")])]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('db.orders.aggregate( [\n   { $unwind: "$items" },\n   {\n     $group: {\n        _id: "$cust_id",\n        qty: { $sum: "$items.qty" }\n     }\n   }\n] )\n')])])]),a("h3",{attrs:{id:"_2-9-multi-aggregate"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-9-multi-aggregate"}},[t._v("#")]),t._v(" 2.9 Multi aggregate")]),t._v(" "),a("p",[t._v("将 "),a("code",[t._v("cust_id")]),t._v(", "),a("code",[t._v("ord_date")]),t._v(" 分组并计算数量 ，不包括日期的时间部分。")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('SELECT COUNT(*)\nFROM (SELECT cust_id,\n             ord_date\n      FROM orders\n      GROUP BY cust_id,\n               ord_date)\n      as DerivedTable\ndb.orders.aggregate( [\n   {\n     $group: {\n        _id: {\n           cust_id: "$cust_id",\n           ord_date: { $dateToString: {\n              format: "%Y-%m-%d",\n              date: "$ord_date"\n           }}\n        }\n     }\n   },\n   {\n     $group: {\n        _id: null,\n        count: { $sum: 1 }\n     }\n   }\n] )\n')])])]),a("h2",{attrs:{id:"参考文章"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参考文章"}},[t._v("#")]),t._v(" 参考文章")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://jelly.jd.com/article/5edf43da70bb2b0168e022b2",target:"_blank",rel:"noopener noreferrer"}},[a("strong",[t._v("从 SQL 到 MongoDB 之聚合篇")]),a("OutboundLink")],1)])])}),[],!1,null,null,null);e.default=n.exports}}]);