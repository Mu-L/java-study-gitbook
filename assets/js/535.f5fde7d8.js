(window.webpackJsonp=window.webpackJsonp||[]).push([[535],{912:function(t,s,a){"use strict";a.r(s);var n=a(26),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"fastdfs安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#fastdfs安装"}},[t._v("#")]),t._v(" FastDFS安装")]),t._v(" "),a("h2",{attrs:{id:"_1-什么是-fastdfs"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-什么是-fastdfs"}},[t._v("#")]),t._v(" 1.什么是 FastDFS")]),t._v(" "),a("h3",{attrs:{id:"_1-1-简介"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-简介"}},[t._v("#")]),t._v(" 1.1 简介")]),t._v(" "),a("p",[t._v("FastDFS 由淘宝的余庆大佬在 2008 年开源的一款轻量级分布式文件管理系统，FastDFS 用 C 语言实现，支持 Linux、FreeBSD、MacOS 等类 UNIX 系统。FastDFS 类似 google FS，属于应用级文件系统，不是通用的文件系统，只能通过专有 API 访问，目前提供了 C 和 Java SDK ，以及 PHP 扩展 SDK。")]),t._v(" "),a("p",[t._v("FastDFS 专为互联网应用量身定做，解决大容量文件存储问题，追求高性能和高扩展性，它可以看做是基于文件的 key/value 存储系统，key 为文件 ID，value 为文件内容，因此称作分布式文件存储服务更为合适。")]),t._v(" "),a("h3",{attrs:{id:"_1-2-为什么需要-fastdfs"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-为什么需要-fastdfs"}},[t._v("#")]),t._v(" 1.2 为什么需要 FastDFS")]),t._v(" "),a("p",[t._v("传统的企业级开发对于高并发要求不是很高，而且数据量可能也不大，在这样的环境下文件管理可能非常 Easy。")]),t._v(" "),a("p",[t._v("但是互联网应用访问量大、数据量大，在互联网应用中，我们必须考虑解决文件大容量存储和高性能访问的问题，而 FastDFS 就特别适合干这件事情，常见的图片存储、视频存储、文档存储等等我们都可以采用 FastDFS 来做。")]),t._v(" "),a("h3",{attrs:{id:"_1-3-fastdfs-架构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-fastdfs-架构"}},[t._v("#")]),t._v(" 1.3 FastDFS 架构")]),t._v(" "),a("p",[t._v("作为一款分布式文件管理系统，FastDFS 主要包括四个方面的功能：")]),t._v(" "),a("ul",[a("li",[t._v("文件存储")]),t._v(" "),a("li",[t._v("文件同步")]),t._v(" "),a("li",[t._v("文件上传")]),t._v(" "),a("li",[t._v("文件下载")])]),t._v(" "),a("p",[t._v("这个方面的功能，基本上就能搞定我们常见的文件管理需求了。")]),t._v(" "),a("p",[t._v("下面这是一张来自 FastDFS 官网的系统架构图：")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/blogimage-master/img/image-20201211172156714.png",alt:"image-20201211172156714"}})]),t._v(" "),a("p",[t._v("从上面这张图中我们可以看到，"),a("strong",[t._v("FastDFS 架构包括 Tracker 和 Storage 两部分，看名字大概就能知道，Tracker 用来追踪文件，相当于是文件的一个索引，而 Storage 则用来保存文件。")])]),t._v(" "),a("p",[t._v("我们上传文件的文件最终保存在 Storage 上，文件的元数据信息保存在 Tracker 上，通过 Tracker 可以实现对 Storage 的负载均衡。")]),t._v(" "),a("p",[t._v("Storage 一般会搭建成集群，一个 Storage Cluster 可以由多个组构成，不同的组之间不进行通信，一个组又相当于一个小的集群，组由多个 Storage Server 组成，组内的 Storage Server 会通过连接进行文件同步来保证高可用。")]),t._v(" "),a("h2",{attrs:{id:"_2-安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-安装"}},[t._v("#")]),t._v(" 2. 安装")]),t._v(" "),a("p",[t._v("为了测试方便，不开启多台虚拟机，Tracker 和 Storage 我将安装在同一台服务器上。")]),t._v(" "),a("p",[t._v("图片上传我们一般使用 FastDFS，图片上传成功之后，接下来的图片访问我们一般采用 Nginx。我们分别从以下三个方面介绍")]),t._v(" "),a("ul",[a("li",[t._v("Tracker 安装")]),t._v(" "),a("li",[t._v("Storage 安装")]),t._v(" "),a("li",[t._v("Nginx 安装（只介绍关键配置）")])]),t._v(" "),a("h3",{attrs:{id:"_2-1-tracker-安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-tracker-安装"}},[t._v("#")]),t._v(" 2.1 Tracker 安装")]),t._v(" "),a("p",[t._v("安装，我们首先需要准备一个环境两个库以及一个安装包。")]),t._v(" "),a("ol",[a("li",[a("p",[t._v("一个环境")]),t._v(" "),a("p",[t._v("FastDFS 采用 C 语言开发，所以在安装之前，如果没有 gcc 环境，需要先安装，安装命令如下：")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("yum install gcc-c++\n")])])])]),t._v(" "),a("li",[a("p",[t._v("两个库")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("libevent")]),t._v(" "),a("p",[t._v("FastDFS 依赖 libevent 库，安装命令如下：")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("yum -y install libevent\n")])])])]),t._v(" "),a("li",[a("p",[t._v("libfastcommon")]),t._v(" "),a("p",[t._v("FastDFS 官方提供的，它包含了 FastDFS 运行所需要的一些基础库。")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/happyfish100/libfastcommon/archive/V1.0.43.tar.gz",target:"_blank",rel:"noopener noreferrer"}},[t._v("下载地址"),a("OutboundLink")],1),t._v(" : https://github.com/happyfish100/libfastcommon/archive/V1.0.43.tar.gz")]),t._v(" "),a("p",[t._v("将下载好的 libfastcommon 拷贝至 /usr/local/ 目录下，然后依次执行如下命令：")]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" /usr/local\n "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("tar")]),t._v(" -zxvf libfastcommon-1.0.43.tar.gz \n "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" libfastcommon-1.0.43/\n ./make.sh\n ./make.sh "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v("\n")])])])])])]),t._v(" "),a("li",[a("p",[t._v("一个安装包")]),t._v(" "),a("p",[t._v("接下来我们下载 Tracker，注意，"),a("strong",[t._v("由于 Tracker 和 Storage 是相同的安装包")]),t._v("，所以下载一次即可")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/happyfish100/fastdfs/archive/V6.06.tar.gz",target:"_blank",rel:"noopener noreferrer"}},[t._v("下载地址"),a("OutboundLink")],1),t._v(" : https://github.com/happyfish100/fastdfs/archive/V6.06.tar.gz")]),t._v(" "),a("p",[t._v("下载成功后，将下载文件拷贝到 /usr/local 目录下，然后依次执行如下命令安装：")]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" /usr/local\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("tar")]),t._v(" -zxvf fastdfs-6.06.tar.gz\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" fastdfs-6.06/\n./make.sh\n./make.sh "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v("\n")])])]),a("p",[t._v("安装成功后，执行如下命令，将安装目录内 conf 目录下的配置文件拷贝到 /etc/fdfs 目录下：")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("cd conf/\ncp ./* /etc/fdfs/\n")])])])]),t._v(" "),a("li",[a("p",[t._v("配置")]),t._v(" "),a("p",[t._v("进入 /etc/fdfs/ 目录下进行配置：")]),t._v(" "),a("p",[t._v("打开 tracker.conf 文件：")]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("vi")]),t._v(" tracker.conf\n")])])]),a("p",[t._v("修改如下配置：")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/blogimage-master/img/image-20201211094903515.png",alt:"image-20201211094903515"}})])])]),t._v(" "),a("ul",[a("li",[t._v("默认端口:22122 （无特殊需求暂不做修改）")]),t._v(" "),a("li",[t._v("元数据的保存目录：（注意目录要存在）")])]),t._v(" "),a("ol",{attrs:{start:"5"}},[a("li",[a("p",[t._v("启动")]),t._v(" "),a("p",[t._v("接下来执行如下命令启动 Tracker：")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("/usr/bin/fdfs_trackerd /etc/fdfs/tracker.conf start\n")])])])])]),t._v(" "),a("h3",{attrs:{id:"_2-2-storage-安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-storage-安装"}},[t._v("#")]),t._v(" 2.2 Storage 安装")]),t._v(" "),a("p",[t._v("这里我们搭建一个 Storage 实例即可。Storage 安装也需要 libevent 和 libfastcommon，这两个库的安装参考上文")]),t._v(" "),a("p",[t._v("Storage 本身的安装，也和 Tracker 一致，执行命令也都一样，因为我这里将 Tracker 和 Storage 安装在同一台服务器上，所以不用再执行安装命令了（相当于安装 Tracker 时已经安装了 Storage 了）。")]),t._v(" "),a("p",[t._v("唯一要做的，就是进入到 /etc/fdfs 目录下，配置 Storage：")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("vi storage.conf\n")])])]),a("p",[a("img",{attrs:{src:"https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/blogimage-master/img/image-20201211101021672.png",alt:"image-20201211101021672"}})]),t._v(" "),a("p",[a("img",{attrs:{src:"https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/blogimage-master/img/image-20201211100945362.png",alt:"image-20201211100945362"}})]),t._v(" "),a("p",[t._v("这里一共配置三个地方，分别是 base_path、store_path0 以及 tracker_server ，tracker_server 模板有两个地址，我们这里只有一个，配置完成后，记得注释掉另外一个不用的。")]),t._v(" "),a("p",[t._v("配置完成后，执行如下命令启动 Storage：")]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[t._v("/usr/bin/fdfs_storaged /etc/fdfs/storage.conf start\n")])])]),a("p",[t._v("这两个启动完成后，现在就可以做文件的上传了，但是一般如果是图片文件，我们还需要提供一个图片的访问功能，目前来说最佳方案当然是 Nginx 了，所以我们这里连同 Nginx 一起配置好，再来做测试。")]),t._v(" "),a("h3",{attrs:{id:"_2-3-nginx-安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-nginx-安装"}},[t._v("#")]),t._v(" 2.3 Nginx 安装")]),t._v(" "),a("p",[t._v("Nginx 的安装分为两个步骤：")]),t._v(" "),a("ul",[a("li",[t._v("安装 Nginx")]),t._v(" "),a("li",[t._v("首先在 Storage 下安装 fastdfs-nginx-module")])]),t._v(" "),a("h4",{attrs:{id:"_2-3-1-安装nginx"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-1-安装nginx"}},[t._v("#")]),t._v(" 2.3.1 安装Nginx")]),t._v(" "),a("p",[t._v("参考："),a("a",{attrs:{href:"http://java.isture.com/linux/nginx/%E5%AE%89%E8%A3%85nginx.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("安装nginx"),a("OutboundLink")],1)]),t._v(" "),a("h4",{attrs:{id:"_2-3-2-storage-下安装-fastdfs-nginx-module"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-2-storage-下安装-fastdfs-nginx-module"}},[t._v("#")]),t._v(" 2.3.2 Storage 下安装 fastdfs-nginx-module")]),t._v(" "),a("ol",[a("li",[a("p",[t._v("下载fastdfs-nginx-module")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/happyfish100/fastdfs-nginx-module/releases",target:"_blank",rel:"noopener noreferrer"}},[t._v("下载地址"),a("OutboundLink")],1)])]),t._v(" "),a("li",[a("p",[t._v("下载完成后，将下载的文件拷贝到 /usr/local 目录下。然后进入 /usr/local 目录，分别执行如下命令：")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("cd /usr/local/\ntar -zxvf fastdfs-nginx-module-1.22.tar.gz\n")])])])]),t._v(" "),a("li",[a("p",[t._v("然后将 "),a("code",[t._v("/usr/local/fastdfs-nginx-module-1.22/src/mod_fastdfs.conf")]),t._v(" 文件拷贝到 "),a("code",[t._v("/etc/fdfs/")]),t._v(" 目录下，并修改该文件的内容：")]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("cp")]),t._v(" /usr/local/fastdfs-nginx-module-1.22/src/mod_fastdfs.conf /etc/fdfs/\n")])])])]),t._v(" "),a("li",[a("p",[t._v("修改mod_fastdfs.conf的内容：")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("vi /etc/fdfs/mod_fastdfs.conf\n")])])]),a("p",[a("img",{attrs:{src:"https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/blogimage-master/img/image-20201211102958727.png",alt:"image-20201211102958727"}})])]),t._v(" "),a("li",[a("p",[t._v("接下来，回到第一步下载的 nginx 安装文件的解压目录中，执行如下命令，重新配置编译安装：")]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[t._v("./configure --add-module"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/usr/local/fastdfs-nginx-module-1.22/src\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("make")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("make")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v("\n")])])])]),t._v(" "),a("li",[a("p",[t._v("安装完成后，修改 nginx 的配置文件，如下：")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("vi /usr/local/nginx/conf/nginx.conf\n")])])]),a("p",[t._v("添加")]),t._v(" "),a("div",{staticClass:"language-ssh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("\tserver {\n        listen          80;\n        server_name     127.0.0.1;       \n\t\tlocation ~/group([0-9]) {\n            ngx_fastdfs_module;\n       \t}\n    }\n")])])]),a("p",[t._v("在这里配置 nginx 请求转发。")]),t._v(" "),a("p",[t._v("配置完成后，启动 nginx，看到如下日志，表示 nginx 启动成功：")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("ngx_http_fastdfs_set pid=19040\n")])])]),a("p",[a("strong",[t._v("疑问：fastdfs-nginx-module 有啥用")])]),t._v(" "),a("p",[t._v("看了整个安装过程之后，很多小伙伴有疑问，到头来还是 nginx 本身直接找到了图片文件目录，fastdfs-nginx-module 到底有啥用？")]),t._v(" "),a("p",[t._v("前面我们说过，Storage 由很多组构成，每个组又是一个小的集群，在每一个组里边，数据会进行同步，但是如果数据还没同步，这个时候就有请求发来了，该怎么办？此时"),a("strong",[t._v("fastdfs-nginx-module 会帮助我们直接从源 Storage 上获取文件。")])])])]),t._v(" "),a("h2",{attrs:{id:"_3-启动fastdfs"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-启动fastdfs"}},[t._v("#")]),t._v(" 3. 启动fastDFS")]),t._v(" "),a("p",[t._v("重启tracker")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("/usr/bin/fdfs_trackerd /etc/fdfs/tracker.conf start\n")])])]),a("p",[t._v("重启storage")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("/usr/bin/fdfs_storaged /etc/fdfs/storage.conf start\n")])])]),a("h2",{attrs:{id:"_4-java客户端调用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-java客户端调用"}},[t._v("#")]),t._v(" 4. Java客户端调用")]),t._v(" "),a("h3",{attrs:{id:"_4-1-相关配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-相关配置"}},[t._v("#")]),t._v(" 4.1 相关配置")]),t._v(" "),a("p",[t._v("安装成功后，接下来我们就用 Java 客户端来测试一下文件上传下载。")]),t._v(" "),a("ol",[a("li",[a("p",[t._v("添加maven 依赖")]),t._v(" "),a("div",{staticClass:"language-xml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-xml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("dependency")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("groupId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("net.oschina.zcx7878"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("groupId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("artifactId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("fastdfs-client-java"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("artifactId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("version")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("1.27.0.0"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("version")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("dependency")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])])]),t._v(" "),a("li",[a("p",[t._v("在项目的 resources 目录下添加 FastDFS 的配置文件 fastdfs-client.properties，内容如下：")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("fastdfs.connect_timeout_in_seconds = 5\nfastdfs.network_timeout_in_seconds = 30\nfastdfs.charset = UTF-8\nfastdfs.http_anti_steal_token = false\nfastdfs.http_secret_key = FastDFS1234567890\nfastdfs.http_tracker_http_port = 80\nfastdfs.tracker_servers = 120.79.200.222:22122\nfastdfs.connection_pool.enabled = true\nfastdfs.connection_pool.max_count_per_entry = 500\nfastdfs.connection_pool.max_idle_time = 3600\nfastdfs.connection_pool.max_wait_time_in_ms = 1000\n")])])]),a("p",[t._v("fastdfs.tracker_servers: 这是 Tracker 的地址，根据实际情况配置即可。")])])]),t._v(" "),a("h3",{attrs:{id:"_4-2-文件上传"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-文件上传"}},[t._v("#")]),t._v(" 4.2 文件上传")]),t._v(" "),a("p",[t._v("配置完成后，先来看文件上传，代码如下：")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v(" "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Test")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("testUpload")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ClientGlobal")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("initByProperties")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"fastdfs-client.properties"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("TrackerClient")]),t._v(" tracker "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("TrackerClient")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("TrackerServer")]),t._v(" trackerServer "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" tracker"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getConnection")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("StorageServer")]),t._v(" storageServer "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("StorageClient1")]),t._v(" client "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("StorageClient1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("trackerServer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" storageServer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("NameValuePair")]),t._v(" nvp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//上传到文件系统")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" fileId "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" client"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("upload_file1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"img\\test.jpg"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"jpg"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                    nvp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            logger"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("info")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fileId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("catch")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Exception")]),t._v(" e"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            e"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("printStackTrace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("执行步骤")]),t._v(" "),a("ol",[a("li",[a("p",[t._v("首先加载配置文件")])]),t._v(" "),a("li",[a("p",[t._v("然后构造一个 TrackerClient 对象")])]),t._v(" "),a("li",[a("p",[t._v("根据这个对象获取到一个 TrackerServer")])]),t._v(" "),a("li",[a("p",[t._v("然后创建一个 StorageClient1 实例")])]),t._v(" "),a("li",[a("p",[t._v("NameValuePair 中保存的是文件的元数据信息，如果有的话，就以 key/value 的方式来设置，如果没有的话，直接给一个 null 即可。")])]),t._v(" "),a("li",[a("p",[t._v("调用 client 的 upload_file1 方法上传文件，第一个参数是文件路径，第二个参数是文件的扩展名，第三个参数就是文件的元数据信息，这个方法的返回值，就是上传文件的访问路径。")]),t._v(" "),a("p",[t._v("执行该方法，打印日志如下：")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("group1/M00/00/00/eE_Ib1_S57OAa6pQAADzHWHkPwM335.jpg\n")])])]),a("p",[t._v("就是文件的路径，此时，在浏览器中输入http://120.79.200.xxx:8701/group1/M00/00/00/eE_Ib1_S57OAa6pQAADzHWHkPwM335.jpg 就可以看到上传的图片了。")])])]),t._v(" "),a("h4",{attrs:{id:"_4-2-1-图片显示不出"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-1-图片显示不出"}},[t._v("#")]),t._v(" 4.2.1 图片显示不出")]),t._v(" "),a("p",[t._v("FastDFS 配好了，Nginx也配好了，可是网页打开图片地址就是访问不了，查看Nginx的log文件看到")]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[t._v("  ERROR - file: /usr/local/src/fastdfs-nginx-module-1.20/src/common.c, line: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("111")]),t._v(", section: group1, you must "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("set")]),t._v(" parameter: group_name"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("\n")])])]),a("p",[t._v("找到 mod_fastdfs.conf ，发现groupname 没有写对(被注释了)")]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# when support multi-group on this storage server, uncomment following section")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("group1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("group_name")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("group1\n  "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("storage_server_port")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("23000")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("store_path_count")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("store_path0")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/home/fastdfsuser/fastdfs\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#store_path1=/home/yuqing/fastdfs1")]),t._v("\n")])])]),a("p",[t._v("重启fastdfs 和 nginx")]),t._v(" "),a("h3",{attrs:{id:"_4-3-文件下载"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-文件下载"}},[t._v("#")]),t._v(" 4.3 文件下载")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("  "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Test")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("testDownload")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ClientGlobal")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("initByProperties")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"fastdfs-client.properties"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("TrackerClient")]),t._v(" tracker "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("TrackerClient")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("TrackerServer")]),t._v(" trackerServer "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" tracker"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getConnection")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("StorageServer")]),t._v(" storageServer "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("StorageClient1")]),t._v(" client "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("StorageClient1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("trackerServer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" storageServer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("byte")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" bytes "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" client"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("download_file1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"group1/M00/00/00/eE_Ib1_S57OAa6pQAADzHWHkPwM335.jpg"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("FileOutputStream")]),t._v(" fos "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("FileOutputStream")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("File")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"img\\\\out.png"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            fos"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("write")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("bytes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            fos"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("close")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("catch")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Exception")]),t._v(" e"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            e"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("printStackTrace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n")])])]),a("p",[t._v("直接调用 download_file1 方法获取到一个 byte 数组，然后通过 IO 流写出到本地文件即可。")]),t._v(" "),a("h2",{attrs:{id:"_5-安全问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-安全问题"}},[t._v("#")]),t._v(" 5. 安全问题")]),t._v(" "),a("p",[t._v("现在，任何人都可以访问我们服务器上传文件，这肯定是不行的，这个问题好解决，加一个上传时候的令牌即可。")]),t._v(" "),a("ol",[a("li",[a("p",[t._v("首先我们在服务端开启令牌校验：")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("vi /etc/fdfs/http.conf\n")])])]),a("p",[a("img",{attrs:{src:"https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/blogimage-master/img/image-20201211150330620.png",alt:"image-20201211150330620"}})])]),t._v(" "),a("li",[a("p",[t._v("重启服务端")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("./nginx -s stop\n./nginx\n")])])])]),t._v(" "),a("li",[a("p",[t._v("前端获取令牌")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v(" "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Test")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getToken")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throws")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Exception")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" ts "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Instant")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("now")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getEpochSecond")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" token "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ProtoCommon")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getToken")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"M00/00/00/eE_Ib1_S57OAa6pQAADzHWHkPwM335.jpg"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ts"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"FastDFS1234567890"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("StringBuilder")]),t._v(" sb "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("StringBuilder")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        sb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("append")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"?token="')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("append")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("token"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        sb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("append")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"&ts="')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("append")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ts"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("System")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("out"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("println")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("toString")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("根据 ProtoCommon.getToken 方法来获取令牌")]),t._v(" "),a("ul",[a("li",[t._v("第一个参数是你要访问的文件 id，"),a("strong",[t._v("注意，这个地址里边不包含 group，千万别搞错了；")])]),t._v(" "),a("li",[t._v("第二个参数是时间戳")]),t._v(" "),a("li",[t._v("第三个参数是密钥，密钥要和服务端的配置一致。")])]),t._v(" "),a("p",[t._v("将生成的字符串拼接，追加到访问路径后面，如：")]),t._v(" "),a("p",[t._v("http://120.79.200.xxx:8701/group1/M00/00/00/eE_Ib1_S57OAa6pQAADzHWHkPwM335.jpg?token=94a8e7167e1583b0efa674d0dbf5fc63&ts=1607670503。"),a("strong",[t._v("此时访问路径里边如果没有令牌，会访问失败。")])])])]),t._v(" "),a("h2",{attrs:{id:"_6-异常处理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-异常处理"}},[t._v("#")]),t._v(" 6.异常处理")]),t._v(" "),a("h3",{attrs:{id:"_6-1-getstorestorage-fail-errno-code-28"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-1-getstorestorage-fail-errno-code-28"}},[t._v("#")]),t._v(" 6.1 getStoreStorage fail, errno code: 28")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/blogimage-master/img/image-20201211113209071.png",alt:"image-20201211113209071"}})]),t._v(" "),a("p",[t._v("引起错误的原因是，在我们配置tracker的时候，里面有一个配置项：")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("# reserved storage space for system or other applications.\n# if the free(available) space of any stoarge server in\n# a group <= reserved_storage_space, no file can be uploaded to this group.\n# bytes unit can be one of follows:\n### G or g for gigabyte(GB)\n### M or m for megabyte(MB)\n### K or k for kilobyte(KB)\n### no unit for byte(B)\n### XX.XX% as ratio such as: reserved_storage_space = 10%\nreserved_storage_space = 10%\n\n")])])]),a("p",[t._v("该配置项是配置storage服务预留磁盘空间的大小的比值，默认是10%，即当磁盘空间不足10%时，则tracker拒绝上传文件。")]),t._v(" "),a("p",[t._v("解决方法：")]),t._v(" "),a("ol",[a("li",[t._v("删除不用文件，最好调用DFS的删除API执行删除，因为DFS会维护一个索引文件，调用API删除时会连同索引文件都会删除。这种方式谨慎使用。")]),t._v(" "),a("li",[t._v("如果文件不允许删除，则需要扩展磁盘。")]),t._v(" "),a("li",[t._v("临时解决方案，调小该比例")])]),t._v(" "),a("h3",{attrs:{id:"_6-2-客户端连接超时"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-2-客户端连接超时"}},[t._v("#")]),t._v(" 6.2 客户端连接超时")]),t._v(" "),a("p",[t._v("connect timed out")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/blogimage-master/image-20210324234312735.png",alt:"image-20210324234312735"}})]),t._v(" "),a("p",[t._v("我们需要确认fdfs 端口是否打开，如果是阿里云服务器，则需要配置安全组")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/blogimage-master/image-20210324234130717.png",alt:"image-20210324234130717"}})]),t._v(" "),a("p",[t._v("端口有两个："),a("strong",[t._v("22122 和23000 都要开启")]),t._v("！！！！")]),t._v(" "),a("h2",{attrs:{id:"参考文章"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参考文章"}},[t._v("#")]),t._v(" 参考文章")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://blog.csdn.net/u012702547/article/details/104589468",target:"_blank",rel:"noopener noreferrer"}},[t._v("手把手教你用 FastDFS 构建分布式文件管理系统"),a("OutboundLink")],1)]),t._v(" "),a("p",[a("a",{attrs:{href:"https://blog.csdn.net/weixin_42591789/article/details/87931282",target:"_blank",rel:"noopener noreferrer"}},[t._v("FastDFS + Nginx 网页访问不了"),a("OutboundLink")],1)])])}),[],!1,null,null,null);s.default=e.exports}}]);