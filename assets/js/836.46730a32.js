(window.webpackJsonp=window.webpackJsonp||[]).push([[836],{1213:function(s,t,a){"use strict";a.r(t);var n=a(26),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"redis如何实现分布式锁"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#redis如何实现分布式锁"}},[s._v("#")]),s._v(" Redis如何实现分布式锁")]),s._v(" "),a("h2",{attrs:{id:"_1-简介"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-简介"}},[s._v("#")]),s._v(" 1. 简介")]),s._v(" "),a("p",[s._v("分布式锁是控制分布式系统或不同系统之间，访问共享资源的一种锁实现")]),s._v(" "),a("p",[s._v("。如果系统之间的锁，往往需要互斥")]),s._v(" "),a("h2",{attrs:{id:"_2-分布式锁需要解决的问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-分布式锁需要解决的问题"}},[s._v("#")]),s._v(" 2. 分布式锁需要解决的问题")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("互斥性")]),s._v(" "),a("p",[s._v("在任意一个时刻，只有一个客户端持有锁")])]),s._v(" "),a("li",[a("p",[s._v("安全性")])]),s._v(" "),a("li",[a("p",[s._v("死锁")]),s._v(" "),a("p",[s._v("即使持有锁的客户端崩溃或者其他意外事件，锁仍然可以被获取")])]),s._v(" "),a("li",[a("p",[s._v("容错")]),s._v(" "),a("p",[s._v("只要大部分 redis节点都活着，客户端就可以获取和释放锁")])])]),s._v(" "),a("h2",{attrs:{id:"_3-setnx-实现分布式锁-错误的做法"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-setnx-实现分布式锁-错误的做法"}},[s._v("#")]),s._v(" 3. SETNX 实现分布式锁（错误的做法）")]),s._v(" "),a("h3",{attrs:{id:"_3-1-setnx-简介"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-setnx-简介"}},[s._v("#")]),s._v(" 3.1 SETNX 简介")]),s._v(" "),a("p",[s._v("语法：")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("# 如果key不存在，则创建并赋值\nSETNX key value \n")])])]),a("ul",[a("li",[s._v("时间复杂度：O(1)")]),s._v(" "),a("li",[s._v("返回值：设置成功，返回1 ，设置失败，返回0")])]),s._v(" "),a("h3",{attrs:{id:"_3-2-示例"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-示例"}},[s._v("#")]),s._v(" 3.2 示例")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/blogimage-master/image-20210410211900583.png",alt:"image-20210410211900583"}})]),s._v(" "),a("p",[s._v("如果该locknx 的key没有被设置过，就能获取到对应的锁，否则获取不到锁。我们用完锁就释放掉。但是如果我们进程挂了，无法正常释放锁，那么key 锁就会长期存在。如何解决这个问题")]),s._v(" "),a("h3",{attrs:{id:"_3-3-如何解决setnx-长期有效问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-如何解决setnx-长期有效问题"}},[s._v("#")]),s._v(" 3.3 如何解决SETNX 长期有效问题")]),s._v(" "),a("p",[s._v("使用EXPIRE key seconds")]),s._v(" "),a("ul",[a("li",[s._v("设置key的生存时间，当key过期时（生存时间为0），会被自动删除")])]),s._v(" "),a("h3",{attrs:{id:"_3-4-存在的问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-存在的问题"}},[s._v("#")]),s._v(" 3.4 存在的问题")]),s._v(" "),a("p",[s._v("例如以下伪代码")]),s._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("boolean")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("tryLock")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" requset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" timeout"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Long")]),s._v(" result "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" jedis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("setnx")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" requset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// result = 1时，设置成功，否则设置失败")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 如果这一步挂了，将无法自动释放锁")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("result "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1L")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" jedis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("expire")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" timeout"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1L")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),a("p",[s._v("实际上上面的步骤是有问题的，setnx和expire是分开的两步操作，不具有原子性，如果执行完第一条指令应用异常或者重启了，锁将无法过期。")]),s._v(" "),a("p",[s._v("一种改善方案就是使用Lua脚本来保证原子性（包含setnx和expire两条指令）")]),s._v(" "),a("h3",{attrs:{id:"_3-5-解决方案-使用lua脚本-包含setnx和expire两条指令"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-5-解决方案-使用lua脚本-包含setnx和expire两条指令"}},[s._v("#")]),s._v(" 3.5 解决方案-使用Lua脚本（包含setnx和expire两条指令）")]),s._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("boolean")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("tryLock_with_lua")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("UniqueId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" seconds"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" lua_scripts "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"if redis.call('setnx',KEYS[1],ARGV[1]) == 1 then\"")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"redis.call('expire',KEYS[1],ARGV[2]) return 1 else return 0 end\"")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("List")]),a("span",{pre:!0,attrs:{class:"token generics"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" keys "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ArrayList")]),a("span",{pre:!0,attrs:{class:"token generics"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("List")]),a("span",{pre:!0,attrs:{class:"token generics"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" values "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ArrayList")]),a("span",{pre:!0,attrs:{class:"token generics"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    keys"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    values"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("UniqueId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    values"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("valueOf")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("seconds"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Object")]),s._v(" result "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" jedis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("eval")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("lua_scripts"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" keys"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" values"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//判断是否成功")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" result"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("equals")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1L")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),a("h2",{attrs:{id:"_4-使用-set-key-value-ex-seconds-px-milliseconds-nx-xx-命令-正确做法-实现分布式锁"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-使用-set-key-value-ex-seconds-px-milliseconds-nx-xx-命令-正确做法-实现分布式锁"}},[s._v("#")]),s._v(" 4. 使用 "),a("code",[s._v("SET key value[EX seconds][PX milliseconds][NX|XX]")]),s._v(" 命令 (正确做法) 实现分布式锁")]),s._v(" "),a("h4",{attrs:{id:"_4-1-简介"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-简介"}},[s._v("#")]),s._v(" 4.1 简介")]),s._v(" "),a("p",[s._v("Redis在 2.6.12 版本开始，为 SET 命令增加一系列选项：")]),s._v(" "),a("p",[s._v("语法")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("SET key value [EX seconds] [PX milliseconds] [NX|XX]\n")])])]),a("ul",[a("li",[s._v("EX second: 设置键的过期时间为second秒")]),s._v(" "),a("li",[s._v("PX millisecond： 设置键的过期时间为milliseconds")]),s._v(" "),a("li",[s._v("NX：只有键不存在时，才对键进行设置操作")]),s._v(" "),a("li",[s._v("XX: 只有键已经存在，才对键进行设置操作")]),s._v(" "),a("li",[s._v("SET 操作成功完成时，返回OK,否则返回nil")])]),s._v(" "),a("p",[s._v("set命令的nx选项，就等同于setnx命令")]),s._v(" "),a("h2",{attrs:{id:"参考文章"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参考文章"}},[s._v("#")]),s._v(" 参考文章")]),s._v(" "),a("p",[a("a",{attrs:{href:"https://juejin.cn/post/6844903830442737671",target:"_blank",rel:"noopener noreferrer"}},[s._v("基于Redis的分布式锁实现"),a("OutboundLink")],1)])])}),[],!1,null,null,null);t.default=e.exports}}]);