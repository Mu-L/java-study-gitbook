(window.webpackJsonp=window.webpackJsonp||[]).push([[295],{672:function(t,s,a){"use strict";a.r(s);var n=a(26),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"p6spy监控你的sql输出"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#p6spy监控你的sql输出"}},[t._v("#")]),t._v(" P6Spy监控你的SQL输出")]),t._v(" "),a("blockquote",[a("p",[t._v("mybatis 的日志只有基础sql语句，并没有完整的sql日志，在开发环境上排查问题实在太麻烦了")])]),t._v(" "),a("h2",{attrs:{id:"_1-简介"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-简介"}},[t._v("#")]),t._v(" 1. 简介")]),t._v(" "),a("p",[t._v("P6Spy是一个可以用来在应用程序中拦截和修改数据操作语句的开源框架。通过P6Spy我们可以对SQL语句进行拦截，相当于一个SQL语句的记录器，这样我们可以用它来作相关的分析，比如性能分析。")]),t._v(" "),a("p",[t._v("P6SPY提供了如下几个功能：")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("记录SQL语句的执行时间戳。")])]),t._v(" "),a("li",[a("p",[t._v("记录SQL语句类型。")])]),t._v(" "),a("li",[a("p",[t._v("记录SQL填入参数的和没有填入参数的SQL语句。")])]),t._v(" "),a("li",[a("p",[t._v("根据配置的时间控制SQL语句的执行时间，对超出时间的SQL语句输出到日志文件中。")])])]),t._v(" "),a("h2",{attrs:{id:"_2-集成配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-集成配置"}},[t._v("#")]),t._v(" 2. 集成配置")]),t._v(" "),a("p",[t._v("配置步骤：")]),t._v(" "),a("h3",{attrs:{id:"_2-1-依赖"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-依赖"}},[t._v("#")]),t._v(" 2.1 依赖")]),t._v(" "),a("div",{staticClass:"language-xml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-xml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("dependency")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n   "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("groupId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("p6spy"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("groupId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n   "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("artifactId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("p6spy"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("artifactId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n   "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("version")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("3.9.1"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("version")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("dependency")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])]),a("h3",{attrs:{id:"_2-2-替换jdbc驱动"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-替换jdbc驱动"}},[t._v("#")]),t._v(" 2.2 替换JDBC驱动")]),t._v(" "),a("p",[t._v("将你的JDBC驱动替换为")]),t._v(" "),a("div",{staticClass:"language-applescript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-applescript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 修改 JDBC 驱动为如下 P6SpyDriver 配置")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 之前为：")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# spring.datasource.driver-class-name=com.mysql.jdbc.Driver")]),t._v("\nspring.datasource.driver"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token class builtin"}},[t._v("class")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("name"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("com.p6spy.engine.spy.P6SpyDriver\n")])])]),a("h3",{attrs:{id:"_2-3-修改数据库地址"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-修改数据库地址"}},[t._v("#")]),t._v(" 2.3 修改数据库地址")]),t._v(" "),a("p",[t._v("修改spring.datasource.url")]),t._v(" "),a("div",{staticClass:"language-ini extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ini"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 注意是 jdbc:p6spy:mysql")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("spring.datasource.url")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v("jdbc:p6spy:mysql://127.0.0.1:3306/test?useUnicode=true&characterEncoding=UTF-8")]),t._v("\n")])])]),a("h3",{attrs:{id:"_2-4-添加配置文件-spy-properties"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-添加配置文件-spy-properties"}},[t._v("#")]),t._v(" 2.4 添加配置文件 spy.properties")]),t._v(" "),a("div",{staticClass:"language-ini extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ini"}},[a("code",[a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("module.log")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v("com.p6spy.engine.logging.P6LogFactory,com.p6spy.engine.outage.P6OutageFactory")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 自定义日志打印,改成你自定义配置类的全类名")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("logMessageFormat")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v("com.zszdevelop.test.aop.P6SpyLogger")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 使用日志系统记录sql")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("appender")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v("com.p6spy.engine.spy.appender.Slf4JLogger")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("## 配置记录Log例外")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("excludecategories")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v("info,debug,result,commit,resultset")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 设置使用p6spy driver来做代理")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("deregisterdrivers")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v("true")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 日期格式")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("dateformat")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v("yyyy-MM-dd HH:mm:ss")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 实际驱动")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("driverlist")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v("com.mysql.jdbc.Driver")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 是否开启慢SQL记录")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#outagedetection=true")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 慢SQL记录标准 秒")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#outagedetectioninterval=2")]),t._v("\n")])])]),a("p",[t._v("注意：")]),t._v(" "),a("div",{staticClass:"language-ini extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ini"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 自定义日志打印,改成你自定义配置类的全类名")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("logMessageFormat")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v("com.zszdevelop.test.aop.P6SpyLogger")]),t._v("\n")])])]),a("h3",{attrs:{id:"_2-5-自定义日志打印"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-5-自定义日志打印"}},[t._v("#")]),t._v(" 2.5 自定义日志打印")]),t._v(" "),a("p",[t._v("可以把 mybatis 占位符填进去，输入完整的sql日志")]),t._v(" "),a("blockquote",[a("p",[t._v("自己想怎么打日志就怎么打")])]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/**\n * 自定义日志\n * 默认com.p6spy.engine.spy.appender.SingleLineFormat\n *\n * @author zsz\n * @date 2022-06-16\n */")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("P6SpyLogger")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("implements")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MessageFormattingStrategy")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/**\n     * 日志格式\n     *\n     * @param connectionId 连接id\n     * @param now          当前时间\n     * @param elapsed      耗时多久\n     * @param category     类别\n     * @param prepared     mybatis带占位符的sql\n     * @param sql          占位符换成参数的sql\n     * @param url          sql连接的 url\n     * @return 自定义格式日志\n     */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Override")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("formatMessage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" connectionId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" now"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("long")]),t._v(" elapsed"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" category"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" prepared"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" sql"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" url"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" log "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("StringUtils")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("isNotBlank")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sql"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            log "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("format")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"\\n-----------  SQL执行时间：%s   SQL执行耗时：%s ms  -----------\\n 执行的 SQL语句：%s\\n"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" now"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" elapsed"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" sql"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("replaceAll")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"[\\\\s]+"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('" "')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            log "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" log"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n")])])]),a("h2",{attrs:{id:"_3-spy-properties详细说明"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-spy-properties详细说明"}},[t._v("#")]),t._v(" 3. spy.properties详细说明")]),t._v(" "),a("div",{staticClass:"language-ini extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ini"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 指定应用的日志拦截模块,默认为com.p6spy.engine.spy.P6SpyFactory")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("modulelist")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v("com.p6spy.engine.spy.P6SpyFactory,com.p6spy.engine.logging.P6LogFactory,com.p6spy.engine.outage.P6OutageFactory")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 真实JDBC driver , 多个以 逗号 分割 默认为空")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("driverlist")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 是否自动刷新 默认 flase")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("autoflush")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v("false")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 配置SimpleDateFormat日期格式 默认为空")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("dateformat")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 打印堆栈跟踪信息 默认flase")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("stacktrace")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v("false")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 如果 stacktrace=true，则可以指定具体的类名来进行过滤。")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("stacktraceclass")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 监测属性配置文件是否进行重新加载")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("reloadproperties")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v("false")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 属性配置文件重新加载的时间间隔，单位:秒 默认60s")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("reloadpropertiesinterval")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v("60")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 指定 Log 的 appender，取值：")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("appender")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v("com.p6spy.engine.spy.appender.Slf4JLogger")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("appender")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v("com.p6spy.engine.spy.appender.StdoutLogger")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("appender")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v("com.p6spy.engine.spy.appender.FileLogger")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 指定 Log 的文件名 默认 spy.log")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("logfile")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v("spy.log")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 指定是否每次是增加 Log，设置为 false 则每次都会先进行清空 默认true")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("append")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v("true")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 指定日志输出样式 默认为com.p6spy.engine.spy.appender.SingleLineFormat , 单行输出 不格式化语句")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("logMessageFormat")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v("com.p6spy.engine.spy.appender.SingleLineFormat")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 也可以采用 com.p6spy.engine.spy.appender.CustomLineFormat 来自定义输出样式, 默认值是%(currentTime)|%(executionTime)|%(category)|connection%(connectionId)|%(sqlSingleLine)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 可用的变量为:")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# %(connectionId) connection id")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# %(currentTime) 当前时间")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# %(executionTime) 执行耗时")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# %(category) 执行分组")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# %(effectiveSql) 提交的SQL 换行")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# %(effectiveSqlSingleLine) 提交的SQL 不换行显示")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# %(sql) 执行的真实SQL语句，已替换占位")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# %(sqlSingleLine) 执行的真实SQL语句，已替换占位 不换行显示")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("customLogMessageFormat")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v("%(currentTime)|%(executionTime)|%(category)|connection%(connectionId)|%(sqlSingleLine)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# date类型字段记录日志时使用的日期格式 默认dd-MMM-yy")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("databaseDialectDateFormat")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v("dd-MMM-yy")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# boolean类型字段记录日志时使用的日期格式 默认boolean 可选值numeric")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("databaseDialectBooleanFormat")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v("boolean")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 是否通过jmx暴露属性 默认true")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("jmx")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v("true")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 如果jmx设置为true 指定通过jmx暴露属性时的前缀 默认为空")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# com.p6spy(.<jmxPrefix>)?:name=<optionsClassName>")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("jmxPrefix")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 是否显示纳秒 默认false")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("useNanoTime")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v("false")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 实际数据源 JNDI")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("realdatasource")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v("/RealMySqlDS")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 实际数据源 datasource class")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("realdatasourceclass")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v("com.mysql.jdbc.jdbc2.optional.MysqlDataSource")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 实际数据源所携带的配置参数 以 k=v 方式指定 以 分号 分割")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("realdatasourceproperties")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v("port;3306,serverName;myhost,databaseName;jbossdb,foo;bar")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# jndi数据源配置")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 设置 JNDI 数据源的 NamingContextFactory。")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("jndicontextfactory")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v("org.jnp.interfaces.NamingContextFactory")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 设置 JNDI 数据源的提供者的 URL。")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("jndicontextproviderurl")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v("localhost:1099")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 设置 JNDI 数据源的一些定制信息，以分号分隔。")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("jndicontextcustom")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v("java.naming.factory.url.pkgs;org.jboss.naming:org.jnp.interfaces")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 是否开启日志过滤 默认false， 这项配置是否生效前提是配置了 include/exclude/sqlexpression")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("filter")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v("false")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 过滤 Log 时所包含的表名列表，以逗号分隔 默认为空")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("include")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 过滤 Log 时所排除的表名列表，以逗号分隔 默认为空")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("exclude")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 过滤 Log 时的 SQL 正则表达式名称 默认为空")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("sqlexpression")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#显示指定过滤 Log 时排队的分类列表，取值: error, info, batch, debug, statement,")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#commit, rollback, result and resultset are valid values")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# (默认 info,debug,result,resultset,batch)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("excludecategories")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v("info,debug,result,resultset,batch")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 是否过滤二进制字段")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# (default is false)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("excludebinary")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v("false")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# P6Log 模块执行时间设置，整数值 (以毫秒为单位)，只有当超过这个时间才进行记录 Log。默认为0")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("executionThreshold")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# P6Outage 模块是否记录较长时间运行的语句 默认false")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("outagedetection")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v("true|false")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# P6Outage 模块执行时间设置，整数值 （以秒为单位)），只有当超过这个时间才进行记录 Log。默认30s")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("outagedetectioninterval")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v("integer time (seconds)")]),t._v("\n")])])]),a("h2",{attrs:{id:"_4-相关问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-相关问题"}},[t._v("#")]),t._v(" 4. 相关问题")]),t._v(" "),a("h3",{attrs:{id:"_4-1-配置了exclude-不生效"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-配置了exclude-不生效"}},[t._v("#")]),t._v(" 4.1 配置了exclude 不生效")]),t._v(" "),a("p",[t._v("切记要先开启过滤：filter=true")]),t._v(" "),a("div",{staticClass:"language-ini extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ini"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 是否开启日志过滤 默认false， 这项配置是否生效前提是配置了 include/exclude/sqlexpression")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("filter")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v("true")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 过滤 Log 时所排除的表名列表，以逗号分隔 默认为空")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("exclude")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v("QRTZ_*")]),t._v("\n")])])]),a("h3",{attrs:{id:"_4-2-总是打印空日志"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-总是打印空日志"}},[t._v("#")]),t._v(" 4.2 总是打印空日志")]),t._v(" "),a("p",[t._v("我们debug 可以看到打印空日志的时候。他的category 为commit,所以我们要排除commit 即可")]),t._v(" "),a("div",{staticClass:"language-ini extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ini"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("## 配置记录Log例外")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("excludecategories")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v("info,debug,result,commit,resultset")]),t._v("\n")])])]),a("p",[a("img",{attrs:{src:"https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220622092110715.png",alt:"image-20220622092110715"}})]),t._v(" "),a("h2",{attrs:{id:"参考文章"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参考文章"}},[t._v("#")]),t._v(" 参考文章")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://segmentfault.com/a/1190000038714503",target:"_blank",rel:"noopener noreferrer"}},[t._v("使用P6Spy监控你的SQL输出"),a("OutboundLink")],1)]),t._v(" "),a("p",[a("a",{attrs:{href:"https://blog.csdn.net/li521wang/article/details/104002897",target:"_blank",rel:"noopener noreferrer"}},[t._v("p6spy配置详解"),a("OutboundLink")],1)])])}),[],!1,null,null,null);s.default=e.exports}}]);