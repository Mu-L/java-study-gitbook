(window.webpackJsonp=window.webpackJsonp||[]).push([[71],{447:function(a,t,s){"use strict";s.r(t);var e=s(26),r=Object(e.a)({},(function(){var a=this,t=a.$createElement,s=a._self._c||t;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("h1",{attrs:{id:"记一次mat分析线上项目过程"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#记一次mat分析线上项目过程"}},[a._v("#")]),a._v(" 记一次MAT分析线上项目过程")]),a._v(" "),s("h2",{attrs:{id:"_1-背景"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-背景"}},[a._v("#")]),a._v(" 1. 背景")]),a._v(" "),s("p",[a._v("前段时间接手了一个项目，正常运行都没有问题。但是"),s("strong",[a._v("运行个几天就会OOM异常")]),a._v("，导致服务不可用。我们首先第一个想到的就是该项目内存泄漏导致，但是项目本身已经比较庞大，要找到一个内存泄漏的点，还是比较难得。")]),a._v(" "),s("p",[a._v("所以我们使用MAT来分析线上项目的运行情况")]),a._v(" "),s("h2",{attrs:{id:"_2-jmap-生成堆转储快照"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-jmap-生成堆转储快照"}},[a._v("#")]),a._v(" 2. "),s("code",[a._v("jmap")]),a._v(":生成堆转储快照")]),a._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("jmap -dump:format=b,file=./heap.hprof 19012\nDumping heap to /home/ftpuser/services/mywebsocket/heap.hprof ...\nHeap dump file created\n")])])]),s("p",[a._v("19012 是进程号")]),a._v(" "),s("p",[a._v("我们将heap.hprof 导出到我们本地，使用MAT来分析")]),a._v(" "),s("h2",{attrs:{id:"_3-mat分析"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-mat分析"}},[a._v("#")]),a._v(" 3. MAT分析")]),a._v(" "),s("h3",{attrs:{id:"_3-1-查看内存泄漏疑点报告"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-查看内存泄漏疑点报告"}},[a._v("#")]),a._v(" 3.1 查看内存泄漏疑点报告")]),a._v(" "),s("p",[a._v("这是最简单有效的方式，我们根据报告的提示来进行分析")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/blogimage-master/img/image-20200107232248818.png",alt:"image-20200107232248818"}})]),a._v(" "),s("p",[a._v("我们点开报告得到")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/blogimage-master/img/image-20200107232335036.png",alt:"image-20200107232335036"}})]),a._v(" "),s("p",[a._v("我们根据报告得知，有个对象已经占用了44.4 MB的内存，他来源于"),s("strong",[a._v("ConcurrentHashMap$Node[]")])]),a._v(" "),s("h3",{attrs:{id:"_3-2-查看histogram"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-查看histogram"}},[a._v("#")]),a._v(" 3.2 查看Histogram")]),a._v(" "),s("p",[a._v("通过查看"),s("strong",[a._v("Histogram")]),a._v("，列出内存中的对象情况（个数，大小）")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/blogimage-master/img/image-20200107233119349.png",alt:"image-20200107233119349"}})]),a._v(" "),s("ul",[s("li",[s("p",[s("strong",[a._v("Class Name")]),a._v(" ： 类名称，java类名")])]),a._v(" "),s("li",[s("p",[a._v("**Objects **： 类的对象的数量，这个对象被创建了多少个")])]),a._v(" "),s("li",[s("p",[s("strong",[a._v("Shallow Heap ：一个对象内存的消耗大小，不包含对其他对象的引用")])])]),a._v(" "),s("li",[s("p",[s("strong",[a._v("Retained Heap ：是shallow Heap的总和，也就是该对象被GC之后所能回收到内存的总和")])])])]),a._v(" "),s("h4",{attrs:{id:"_3-2-1-通过正则查找自己的类"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-1-通过正则查找自己的类"}},[a._v("#")]),a._v(" 3.2.1 通过正则查找自己的类")]),a._v(" "),s("p",[a._v("这儿借助工具提供的regex正则搜索一下我们自己的类，排序后看看哪些相对是占用比较大的。")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/blogimage-master/img/image-20200107233400178.png",alt:"image-20200107233400178"}})]),a._v(" "),s("p",[a._v("我们可以看出内存泄漏是有EsscWebSocket开始的")]),a._v(" "),s("h3",{attrs:{id:"_3-3-查看dominator-tree"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-查看dominator-tree"}},[a._v("#")]),a._v(" 3.3 查看Dominator Tree")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/blogimage-master/img/image-20200107233826983.png",alt:"image-20200107233826983"}})]),a._v(" "),s("h3",{attrs:{id:"_3-4-top-consumers"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-top-consumers"}},[a._v("#")]),a._v(" 3.4 Top consumers")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/blogimage-master/img/image-20200107233905138.png",alt:"image-20200107233905138"}})]),a._v(" "),s("p",[s("strong",[a._v("这张图展示的是占用内存比较多的****对象的分布，下面是具体的一些类和占用。")])]),a._v(" "),s("p",[s("img",{attrs:{src:"https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/blogimage-master/img/image-20200107234011953.png",alt:"image-20200107234011953"}})]),a._v(" "),s("h2",{attrs:{id:"参考文章"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#参考文章"}},[a._v("#")]),a._v(" 参考文章")]),a._v(" "),s("p",[s("a",{attrs:{href:"https://www.cnblogs.com/AloneSword/p/3821569.html",target:"_blank",rel:"noopener noreferrer"}},[a._v("Java程序内存分析：使用mat工具分析内存占用"),s("OutboundLink")],1)])])}),[],!1,null,null,null);t.default=r.exports}}]);